​     最近看到我的博文里，[最近面试java后端开发的感受：如果就以平时项目经验来面试，通过估计很难——再论面试前的准备](https://www.cnblogs.com/JavaArchitect/p/10011253.html)，这篇博文，推荐数最多，77推荐0反对，所以能看出面试类文章还是非常受欢迎的。而且，在这个寒冬中，我们更得不断提升自己的能力，所以这次，我就针对上述博文中的“虚拟机描述”这个点扩展出去，具体讲些在面试中展示虚拟机内存调优能力的话术。

​    在面试中展示出这个技能有什么好处？初学者或初级程序员在面试时如果能证明自己具有这方面的能力，这相当有利，因为这是针对5年左右相关经验的高级程序员的要求。如果在面试时面试官主动问及这方面的问题，大家可以按照如下的思路由浅入深地依次阐述，如果没问，大家也可以用到下面提及的方法毫无痕迹地（不突兀不显摆）展示自己这方面的能力。

1 **从虚拟机体系结构引出内存管理的话题**

​    如果面试官有直接问，“你是否了解虚拟机体系结构”，那么大家可以先画出虚拟机的各部件，随后依次说明各部分的作用。

​    其实面试官也知道这部分对项目开发的帮助并不大，所以大家不用过于深入，比如可以不用深入回答.class字节码文件的结构和类加载器的流程。但大家一定得总结性地说出静态数据、基本数据类型和引用等数据的存储位置，这部分的内容在博文里和我的书里讲过。这样就能引出后面的关于“内存”的话题。

​    如果面试官没有问及虚拟机体系结构的问题，那么也不要紧，毕竟这块知识点实用性一般，说出来属于锦上添花。但大家应当通过后文部分给出的方法，找机会引出“内存“这个话题。

**2 如何自然地引出内存管理的话题**

​     一般来说，大多数面试官会问垃圾回收的流程，这样大家就有机会通过堆结构说出垃圾回收的流程，进而展示自己内存调优方面的能力。

​    或者大家可以更保险点，在简历的最近项目介绍里加上类似这样描述，“这个项目的内存要求比较高，虽然在项目里分配的对象不少，但这个项目只被分配了1G内存，所以在这个项目里，我实践了一些定位排查内存问题的技能，也做了些调优的工作“，这样面试官见到简历的描述，就会自然而然地提问了。

​    更稳妥的方法是，在面试中总会有“项目介绍”这个环节，面试官会让候选人介绍最近的（或最拿得出手）的一个项目，这样大家就可以顺势说出刚才已经给出的描述。

​    或者，大家可以在回答数据库或集合等方面的问题时引出这个话题，比如回答完JDBC问题后，大家可以说一句，“用好的Connection对象我们会及时关闭，否则它所占用的内存对象无法被GC回收”，或者在谈及List等集合类型时，同时多说一句，“用好的集合对象我们会及时clear掉，否则这个集合也会对一些对象产生强引用，这样就会延迟对象的回收时间”。

​    总之，内存调优这方面的能力不说出来未免有些可惜，大家可以根据上述的描述举一反三，在面试中找一切可以的机会引入这个话题。

​    不过这里也请大家注意些技巧，别自说自话地一股脑地全说，这样反而过犹不及。打个非常不恰当的比方，就像钓鱼，大家可以先下个饵，比如在介绍项目时先粗略地提到自己做过这方面的事情，但先别说具体的，等面试官主动问了，再具体地按下文给出的思路一一展开。

​    万一面试官在大家的再三暗示下还是没接口继续问（虽然这种可能性非常小），那说明面试官真的对此没兴趣，或者说你应聘的公司对此没需求，那么大家就只能此打住了。

**3 根据堆区结构，阐述垃圾回收的流程**

​    在找到合适的机会后，大家可以先从堆的结构入手，进而详细说明垃圾回收的流程。比如大家被问到，你对Java中的垃圾回收机制了解多少？或者当你说出在项目里你做过内存调优，面试官进一步让你说出细节，那么大家可以按次序说出如下的要点。

​    1 可以先说下，new出来的对象都放在堆区里。

​    2 可以说下堆的结构，比如堆里分年轻区，年老区和持久区，年轻区里还分伊甸区和两个缓冲区，持久区主要存放的是Java类信息或在代码里通过import引入的类信息，垃圾回收流程主要涉及到的是年轻和年老区。

​    3 可以说下垃圾回收的一般流程，比如什么时候会触发轻量级回收，什么时候会触发Full GC。

​    4 可以说下虚拟机是凭什么判断对象可以被回收（对象上没有强引用，则会在下次GC流程时被回收），也可以说下“引用计数法”和“根搜索算法”以及它们的差别。

​    5 可以说下，程序员可以通过System.gc()来启动Full GC，但Full GC并不是在调用和这个方法后就启动。不过根据实践，两者的时间间隔不会太长。

​    在说完上述要点后，大家最后一定得引出下一个“内存调优”这个话题，比如可以说，“虽然说Java虚拟机能自动回收内存，但在平时写代码时，我们会遵循一些要点来提升内存性能，在项目里，我们还会监控内存使用量，而且我在项目里也有过排查OOM问题的经验“。这样的话就能进一步展示自己的“调优和排查”能力。

**4 再进一步说明如何写出高性能的代码**

​    这里来总结一下要点，在面试时，大家可以在阅读[Java核心技术及面试指南](https://item.jd.com/12421187.html)中的相关内容，在此基础上自行展开叙述。

​    1 物理对象（比如Connectio或IO）用好之后得及时close。

​    2 大的对象用好后应当及时设置成null，以撤销强引用。

​    3 集合对象用好后应当及时clear。

​    4 尽量别频繁地使用String（或其它不变类）对象，这样容易产生内存碎片。

​    5 尽可能地使用软和弱引用，因为这样能提早对象的被回收时间。

​    6 不建议重写finalize方法。

​    7 可以通过调整命令行参数来调整堆内存的性能，但同时请注意，在项目里一般只会修改-Xms或-Xmx参数，或者再加一些日志打印和保存Dump文件的参数。在修改其它参数时，项目组一般会很慎重，所以大家可以说自己了解其它的参数，但如果没有十足的把握，别说自己在项目里调整过类似于“设置年轻区与年老区的比值”等容易产生内存问题的参数。

​    解决问题相对容易，但定位问题就相对难了，所以建议大家可以再进一步展示自己“监控、定位和调优”方面的能力，比如可以通过如下的叙述引入到这个话题，“除了这些代码上的技巧外，我们在项目上线后还必须监控内存使用量，一旦发生OOM或Stop The World等问题，我们得通过一定的方法来定位问题点，从而再用刚才提到的技巧来优化内存”。

**5 最后展示监控、定位和调优方面的综合能力**

​    在面试时，面试官是没法当场给出一个实际的问题让大家来现场解决，只要候选人叙述得不离谱，一些要点能说上来，一般就会认为候选人具备这方面的能力。

​    这块大家说下，比如通过JConsole确认有内存问题，通过MAT文件Dump文件来查看OOM的现场，从而再通过GC日志和代码里输出的内存使用量来定位问题点。在面试前，建议大家多看一些GC日志文件和Dump文件，这样在叙述时就更会胸有成竹了。

​    而且，可以准备一两个通过MAT等工具排查解决实际OOM的案例，这样说服力就更强了。

​    通过阅读这部分的内容，大家一定能体会到，“内存监控、定位和调优”方面的能力并不难学，也不难准备面试中的说辞，而且在面试中，最多用上五分钟就能把这部分的知识点说全,但大家一旦按上述思路展示出了这方面能力，那么很大程度能改变面试官对你的评价。

​    根据我们的面试经验，初级程序员的平均能力其实差不了多少，在很多时候我们是无法取舍的。比如我们要从10个人里招5个人进来，除去特别好的（一般2个）和特别差的（一般也是2个），有6个人的综合能力（包括学校背景工作背景项目经验和面试结果）是差不多的，也就是说我们很难从这6个人里挑选出3个人。

​    这时，如果这6人中谁有类似于内存调优（或者之前提到的设计模式）等方面的加分项，那么就一定会优先考虑这个人，这就是本文给大家的帮助。 